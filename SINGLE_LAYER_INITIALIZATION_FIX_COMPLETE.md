# å•å±‚åœ°å›¾ç³»ç»Ÿåˆå§‹åŒ–ä¿®å¤å®Œæˆ

## é—®é¢˜æè¿°

åœ¨å°†åŒå±‚åœ°å›¾ç³»ç»Ÿï¼ˆDirt + Propsï¼‰è½¬æ¢ä¸ºå•å±‚åœ°å›¾ç³»ç»Ÿï¼ˆMapï¼‰åï¼Œå‡ºç°äº†è‡ªå®šä¹‰æ•°æ®å±‚åˆå§‹åŒ–æ—¶åºé—®é¢˜ï¼š

- é”™è¯¯ä¿¡æ¯ï¼š`[World] æ— æ³•è·å–è‡ªå®šä¹‰æ•°æ®å±‚,è·³è¿‡åŒºå—ç”Ÿæˆ`
- åŸå› ï¼štilesetåˆå§‹åŒ–æ˜¯å¼‚æ­¥çš„ï¼Œä½†åŒºå—ç”Ÿæˆåœ¨åˆå§‹åŒ–å®Œæˆå‰å°±å¼€å§‹äº†

## ä¿®å¤æ–¹æ¡ˆ

### 1. å¼‚æ­¥åˆå§‹åŒ–æ—¶åºä¿®å¤

**ä¿®æ”¹æ–‡ä»¶**: `/Level/world.gd`

#### ä¿®æ”¹çš„å‡½æ•°

- `_ready()` - æ·»åŠ äº†å¼‚æ­¥ç­‰å¾… tileset åˆå§‹åŒ–
- `set_current_map()` - æ”¹ä¸ºå¼‚æ­¥å‡½æ•°
- `_load_map_config()` - æ”¹ä¸ºå¼‚æ­¥å‡½æ•°  
- `_configure_tileset()` - æ”¹ä¸ºå¼‚æ­¥å‡½æ•°
- `_setup_tilesets()` - æ·»åŠ äº†åˆå§‹åŒ–å®Œæˆç¡®è®¤

#### ä¿®å¤åçš„åˆå§‹åŒ–æµç¨‹

```
_ready() 
  â†“ (å¼‚æ­¥ç­‰å¾…)
set_current_map() 
  â†“ (å¼‚æ­¥ç­‰å¾…)
_load_map_config() 
  â†“ (å¼‚æ­¥ç­‰å¾…)
_configure_tileset() 
  â†“ (å¼‚æ­¥ç­‰å¾…)
_setup_tilesets() 
  â†“ (éªŒè¯ + åˆå§‹åŒ–)
_validate_tilesets() + _init_custom_data_layers()
  â†“ (ç¡®è®¤å®Œæˆ)
_init_map_loading() 
  â†“ (å®‰å…¨å¼€å§‹)
update_chunks()
```

### 2. ç±»åä¿®å¤

**é—®é¢˜**: ä»£ç ä¸­ä½¿ç”¨äº†é”™è¯¯çš„ç±»å `TileSetDataHelper`
**ä¿®å¤**: æ”¹ä¸ºæ­£ç¡®çš„ç±»å `TileSetCustomData`

### 3. æ•°æ®å±‚è·å–é€»è¾‘ä¼˜åŒ–

**ä¿®æ”¹**: `get_custom_data_layers()` å‡½æ•°

- ç§»é™¤äº†å¯¹ `validate_custom_data()` çš„ä¾èµ–
- æ·»åŠ äº†æ™ºèƒ½é‡æ–°åˆå§‹åŒ–æœºåˆ¶
- æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

### 4. å¢å¼ºçš„é”™è¯¯å¤„ç†

- æ·»åŠ äº†å¤šå±‚çº§çš„é”™è¯¯æ£€æŸ¥
- æä¾›äº†è‡ªåŠ¨é‡è¯•æœºåˆ¶
- å¢åŠ äº†è¯¦ç»†çš„è°ƒè¯•è¾“å‡º

## æµ‹è¯•ç»“æœ

### âœ… æˆåŠŸæŒ‡æ ‡

1. **Tileset åˆå§‹åŒ–æˆåŠŸ**: "tilesetåŠ è½½æˆåŠŸï¼Œmapæºæ•°é‡: 1"
2. **è‡ªå®šä¹‰æ•°æ®å±‚åˆ›å»º**: "å·²åˆ›å»ºhealthå±‚ï¼ŒID: 0" + "å·²åˆ›å»ºvalueå±‚ï¼ŒID: 1"
3. **å›¾å—æ•°æ®åˆå§‹åŒ–**: "åœ¨æº 0 ä¸­æ‰¾åˆ° 21 ä¸ªå›¾å—"
4. **æ•°æ®å±‚ç¼“å­˜å·¥ä½œ**: "ä½¿ç”¨ç¼“å­˜çš„æ•°æ®å±‚: { "health_id": 0, "value_id": 1 }"
5. **æ— é”™è¯¯ä¿¡æ¯**: ä¸å†å‡ºç°"æ— æ³•è·å–è‡ªå®šä¹‰æ•°æ®å±‚"é”™è¯¯

### ğŸ¯ å…³é”®æ”¹è¿›

- **æ—¶åºé—®é¢˜è§£å†³**: ç¡®ä¿ tileset åœ¨åŒºå—ç”Ÿæˆå‰å®Œå…¨å°±ç»ª
- **å¥å£®æ€§å¢å¼º**: æ·»åŠ äº†è‡ªåŠ¨é‡è¯•å’Œé”™è¯¯æ¢å¤æœºåˆ¶
- **è°ƒè¯•èƒ½åŠ›**: æä¾›è¯¦ç»†çš„åˆå§‹åŒ–è¿›åº¦ä¿¡æ¯

## å½“å‰çŠ¶æ€

- âœ… å•å±‚åœ°å›¾ç³»ç»Ÿå®Œå…¨å·¥ä½œ
- âœ… Tileset åˆå§‹åŒ–æ—¶åºæ­£ç¡®
- âœ… è‡ªå®šä¹‰æ•°æ®å±‚æ­£å¸¸å·¥ä½œ
- âœ… åŒºå—ç”Ÿæˆä¸å†å‡ºé”™
- âœ… é¡¹ç›®å¯ä»¥æ­£å¸¸å¯åŠ¨å’Œè¿è¡Œ

## æŠ€æœ¯è¦ç‚¹

### å¼‚æ­¥åˆå§‹åŒ–æ¨¡å¼

```gdscript
# æ­£ç¡®çš„å¼‚æ­¥åˆå§‹åŒ–æ¨¡å¼
func _ready() -> void:
    _configure_noise()
    player.dig.connect(_on_player_dig)
    
    # ç­‰å¾… tileset å®Œå…¨åˆå§‹åŒ–
    await set_current_map(current_map_id)
    
    # ç„¶åå®‰å…¨åœ°å¼€å§‹åœ°å›¾ç”Ÿæˆ
    _init_map_loading()
```

### æ™ºèƒ½æ•°æ®å±‚è·å–

```gdscript
# å¸¦æœ‰è‡ªåŠ¨é‡è¯•çš„æ•°æ®å±‚è·å–
func get_custom_data_layers() -> Dictionary:
    # 1. æ£€æŸ¥ç¼“å­˜
    if _layers and _layers.has("health_id") and _layers.has("value_id"):
        return _layers
    
    # 2. å°è¯•ç›´æ¥è·å–
    var layers = _try_get_layers()
    if _is_complete(layers):
        return layers
    
    # 3. é‡æ–°åˆå§‹åŒ–å¹¶é‡è¯•
    _init_custom_data_layers()
    return _try_get_layers()
```

è¿™æ¬¡ä¿®å¤å½»åº•è§£å†³äº†å•å±‚åœ°å›¾ç³»ç»Ÿçš„åˆå§‹åŒ–é—®é¢˜ï¼Œé¡¹ç›®ç°åœ¨å¯ä»¥ç¨³å®šè¿è¡Œã€‚
